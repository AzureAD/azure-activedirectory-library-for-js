// @preserve Copyright (c) Microsoft Open Technologies, Inc.
"use strict";"undefined"!=typeof module&&module.exports&&(module.exports.inject=function(t){return new AuthenticationContext(t)}),function(){if(angular){var t=angular.module("AdalAngular",[]);t.provider("adalAuthenticationService",function(){var t=null,e={isAuthenticated:!1,userName:"",loginError:"",profile:""},i=function(i){var n=t.getCachedToken(i);e.isAuthenticated=null!==n&&n.length>0;var o=t.getCachedUser()||{userName:""};e.userName=o.userName,e.profile=o.profile,e.loginError=t.getLoginError()};this.init=function(e,n){if(!e)throw Error("You must set configOptions, when calling init");var o=window.location.hash,s=window.location.href;o&&(s=s.replace(o,"")),e.redirectUri=e.redirectUri||s,e.postLogoutRedirectUri=e.postLogoutRedirectUri||s,n&&n.interceptors&&n.interceptors.push("ProtectedResourceInterceptor"),t=new AuthenticationContext(e),i(t.config.loginResource)},this.$get=["$rootScope","$window","$q","$location","$timeout",function(n,o,s,r,a){function h(t,e){return e.requireADLogin?t.requireADLogin!==!1:!!t.requireADLogin}var c=function(){var s=o.location.hash;if(t.isCallback(s)){var h=t.getRequestInfo(s);if(t.saveTokenFromHash(h),r.$$html5?o.location=o.location.origin+o.location.pathname:o.location.hash="",h.requestType!==t.REQUEST_TYPE.LOGIN&&(t._renewActive=!1,t.callback=o.parent.AuthenticationContext().callback,h.requestType===t.REQUEST_TYPE.RENEW_TOKEN&&(t.callback=o.parent.callBackMappedToRenewStates[h.stateResponse])),h.stateMatch)if("function"==typeof t.callback){if(h.requestType===t.REQUEST_TYPE.RENEW_TOKEN){if(h.parameters.access_token)return void t.callback(t._getItem(t.CONSTANTS.STORAGE.ERROR_DESCRIPTION),h.parameters.access_token);if(h.parameters.id_token)return void t.callback(t._getItem(t.CONSTANTS.STORAGE.ERROR_DESCRIPTION),h.parameters.id_token)}}else i(t.config.loginResource),e.userName?(a(function(){i(t.config.loginResource),n.userInfo=e;var o=t._getItem(t.CONSTANTS.STORAGE.START_PAGE);if(o){var s=t._getItem(t.CONSTANTS.STORAGE.START_PAGE_PARAMS);if(s){var a=JSON.parse(s);r.url(o).search(a)}else r.url(o)}},1),n.$broadcast("adal:loginSuccess",t.config.loginResource)):n.$broadcast("adal:loginFailure",t._getItem(t.CONSTANTS.STORAGE.ERROR_DESCRIPTION),t.config.loginResource);else n.$broadcast("adal:stateMismatch",t._getItem(t.CONSTANTS.STORAGE.ERROR_DESCRIPTION))}else i(t.config.loginResource),t._renewActive||e.isAuthenticated||!e.userName||(t._renewActive=!0,t.acquireToken(t.config.loginResource,function(i,o){i?n.$broadcast("adal:loginFailure","auto renew failure",t.config.loginResource):o&&(e.isAuthenticated=!0,n.$broadcast("adal:loginSuccess",t.config.loginResource))}));a(function(){i(t.config.loginResource),n.userInfo=e},1)},u=function(){t.info("Login event for:"+r.$$url),t.config&&t.config.localLoginUrl?r.path(t.config.localLoginUrl):(t._saveItem(t.CONSTANTS.STORAGE.START_PAGE,r.$$url),t.info("Start login at:"+window.location.href),n.$broadcast("adal:loginRedirect"),t.login())},T=function(i,n){n&&n.$$route&&h(n.$$route,t.config)&&(e.isAuthenticated||t._renewActive||(t.info("Route change event for:"+r.$$url),u()))},S=function(i,n,o){n&&h(n,t.config)&&(e.isAuthenticated||t._renewActive||(r.$$url=n.url,t._saveItem(t.CONSTANTS.STORAGE.START_PAGE_PARAMS,JSON.stringify(o)),t.info("State change event for:"+r.$$url),u()))};return n.$on("$routeChangeStart",T),n.$on("$stateChangeStart",S),n.$on("$locationChangeStart",c),i(t.config.loginResource),n.userInfo=e,{config:t.config,login:function(){t.login()},loginInProgress:function(){return t.loginInProgress()},logOut:function(){t.logOut()},getCachedToken:function(e){return t.getCachedToken(e)},userInfo:e,acquireToken:function(e){var i=s.defer();return t._renewActive=!0,t.acquireToken(e,function(n,o){t._renewActive=!1,n?(t.error("Error when acquiring token for resource: "+e,n),i.reject(n)):i.resolve(o)}),i.promise},getUser:function(){var e=s.defer();return t.getUser(function(i,n){i?(t.error("Error when getting user",i),e.reject(i)):e.resolve(n)}),e.promise},getResourceForEndpoint:function(e){return t.getResourceForEndpoint(e)},clearCache:function(){t.clearCache()},clearCacheForResource:function(e){t.clearCacheForResource(e)},info:function(e){t.info(e)},verbose:function(e){t.verbose(e)}}}]}),t.factory("ProtectedResourceInterceptor",["adalAuthenticationService","$q","$rootScope",function(t,e,i){return{request:function(i){if(i){i.headers=i.headers||{};var n=t.getResourceForEndpoint(i.url);if(null===n)return i;var o=t.getCachedToken(n);if(o)return t.info("Token is avaliable for this url "+i.url),i.headers.Authorization="Bearer "+o,i;if(t.loginInProgress())return t.info("login already start."),e.reject("login in progress, cancelling the request");var s=e.defer();return t.acquireToken(n).then(function(e){t.verbose("Token is avaliable"),i.headers.Authorization="Bearer "+e,s.resolve(i)},function(t){s.reject(t)}),s.promise}},responseError:function(n){if(t.info("Getting error in the response"),n){if(401===n.status){var o=t.getResourceForEndpoint(n.config.url);t.clearCacheForResource(o),i.$broadcast("adal:notAuthorized",n,o)}else i.$broadcast("adal:errorResponse",n);return e.reject(n)}}}}])}else console.error("Angular.JS is not included")}();
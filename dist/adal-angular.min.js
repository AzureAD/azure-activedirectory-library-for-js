// @preserve Copyright (c) Microsoft Open Technologies, Inc.
"use strict";"undefined"!=typeof module&&module.exports&&(module.exports.inject=function(e){return new AuthenticationContext(e)}),function(){if(angular){var e=angular.module("AdalAngular",[]);e.provider("adalAuthenticationService",function(){var e=null,t={isAuthenticated:!1,userName:"",loginError:"",profile:""},n=function(n){var i=e.getCachedToken(n);t.isAuthenticated=null!==i&&i.length>0;var o=e.getCachedUser()||{userName:""};t.userName=o.userName,t.profile=o.profile,t.loginError=e.getLoginError()};this.init=function(t,i){if(!t)throw Error("You must set configOptions, when calling init");var o=window.location.hash,r=window.location.href;o&&(r=r.replace(o,"")),t.redirectUri=t.redirectUri||r,t.postLogoutRedirectUri=t.postLogoutRedirectUri||r,i&&i.interceptors&&i.interceptors.push("ProtectedResourceInterceptor"),e=new AuthenticationContext(t),n(e.config.loginResource)},this.$get=["$rootScope","$window","$q","$location","$timeout",function(i,o,r,s,a){function c(e,t){return t.requireADLogin?e.requireADLogin!==!1:!!e.requireADLogin}var u=function(){var r=o.location.hash;if(e.isCallback(r)){var c=e.getRequestInfo(r);if(e.saveTokenFromHash(c),s.$$html5?o.location=o.location.origin+o.location.pathname:o.location.hash="",c.requestType!==e.REQUEST_TYPE.LOGIN&&(e._renewActive=!1,e.callback=o.parent.AuthenticationContext().callback,c.requestType===e.REQUEST_TYPE.RENEW_TOKEN&&(e.callback=o.parent.callBackMappedToRenewStates[c.stateResponse])),c.stateMatch)if("function"==typeof e.callback){if(c.requestType===e.REQUEST_TYPE.RENEW_TOKEN){if(c.parameters.access_token)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),c.parameters.access_token);if(c.parameters.id_token)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),c.parameters.id_token)}}else n(e.config.loginResource),t.userName?(a(function(){n(e.config.loginResource),i.userInfo=t;var o=e._getItem(e.CONSTANTS.STORAGE.START_PAGE);if(o){var r=e._getItem(e.CONSTANTS.STORAGE.START_PAGE_PARAMS);if(r){var a=JSON.parse(r);s.url(o).search(a)}else s.url(o)}},1),i.$broadcast("adal:loginSuccess",e.config.loginResource)):i.$broadcast("adal:loginFailure",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),e.config.loginResource);else i.$broadcast("adal:stateMismatch",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION))}else n(e.config.loginResource),e._renewActive||t.isAuthenticated||!t.userName||(e._renewActive=!0,e.acquireToken(e.config.loginResource,function(n,o){n?i.$broadcast("adal:loginFailure","auto renew failure",e.config.loginResource):o&&(t.isAuthenticated=!0,i.$broadcast("adal:loginSuccess",e.config.loginResource))}));a(function(){n(e.config.loginResource),i.userInfo=t},1)},h=function(){e.info("Login event for:"+s.$$url),e.config&&e.config.localLoginUrl?s.path(e.config.localLoginUrl):(e._saveItem(e.CONSTANTS.STORAGE.START_PAGE,s.$$url),e.info("Start login at:"+window.location.href),i.$broadcast("adal:loginRedirect"),e.login())},l=function(n,i){i&&i.$$route&&c(i.$$route,e.config)&&(t.isAuthenticated||e._renewActive||(e.info("Route change event for:"+s.$$url),h()))},T=function(n,i,o){i&&c(i,e.config)&&(t.isAuthenticated||e._renewActive||(s.$$url=i.url,e._saveItem(e.CONSTANTS.STORAGE.START_PAGE_PARAMS,JSON.stringify(o)),e.info("State change event for:"+s.$$url),h()))};return i.$on("$routeChangeStart",l),i.$on("$stateChangeStart",T),i.$on("$locationChangeStart",u),n(e.config.loginResource),i.userInfo=t,{config:e.config,login:function(){e.login()},loginInProgress:function(){return e.loginInProgress()},logOut:function(){e.logOut()},getCachedToken:function(t){return e.getCachedToken(t)},userInfo:t,acquireToken:function(t){var n=r.defer();return e._renewActive=!0,e.acquireToken(t,function(i,o){e._renewActive=!1,i?(e.error("Error when acquiring token for resource: "+t,i),n.reject(i)):n.resolve(o)}),n.promise},getUser:function(){var t=r.defer();return e.getUser(function(n,i){n?(e.error("Error when getting user",n),t.reject(n)):t.resolve(i)}),t.promise},getResourceForEndpoint:function(t){return e.getResourceForEndpoint(t)},clearCache:function(){e.clearCache()},clearCacheForResource:function(t){e.clearCacheForResource(t)},info:function(t){e.info(t)},verbose:function(t){e.verbose(t)}}}]}),e.factory("ProtectedResourceInterceptor",["adalAuthenticationService","$q","$rootScope",function(e,t,n){return{request:function(n){if(n){n.headers=n.headers||{};var i=e.getResourceForEndpoint(n.url);if(null===i)return n;var o=e.getCachedToken(i);if(o)return e.info("Token is avaliable for this url "+n.url),n.headers.Authorization="Bearer "+o,n;if(e.loginInProgress())return e.info("login already start."),t.reject("login in progress, cancelling the request");var r=t.defer();return e.acquireToken(i).then(function(t){e.verbose("Token is avaliable"),n.headers.Authorization="Bearer "+t,r.resolve(n)},function(e){r.reject(e)}),r.promise}},responseError:function(i){if(e.info("Getting error in the response"),i){if(401===i.status){var o=e.getResourceForEndpoint(i.config.url);e.clearCacheForResource(o),n.$broadcast("adal:notAuthorized",i,o)}else n.$broadcast("adal:errorResponse",i);return t.reject(i)}}}}])}else console.error("Angular.JS is not included")}();

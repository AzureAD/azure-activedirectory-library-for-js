// @preserve Copyright (c) Microsoft Open Technologies, Inc.
"use strict";"undefined"!=typeof module&&module.exports&&(module.exports.inject=function(e){return new AuthenticationContext(e)}),function(){if(angular){var e=angular.module("AdalAngular",[]);e.provider("adalAuthenticationService",function(){var e=null,o={isAuthenticated:!1,userName:"",loginError:"",profile:""},n=!1,r={},t=function(n){var r=e.getCachedToken(n);o.isAuthenticated=null!==r&&r.length>0;var t=e.getCachedUser()||{userName:""};o.userName=t.userName,o.profile=t.profile,o.loginError=e.getLoginError()};this.init=function(o,n){if(!o)throw Error("You must set configOptions, when calling init");var r=window.location.hash,i=window.location.href;r&&(i=i.replace(r,"")),o.redirectUri=o.redirectUri||i,o.postLogoutRedirectUri=o.postLogoutRedirectUri||i,n&&n.interceptors&&n.interceptors.push("ProtectedResourceInterceptor"),e=new AuthenticationContext(o),t(e.config.loginResource)},this.$get=["$rootScope","$window","$q","$location","$timeout",function(i,a,c,u,s){function l(e,o){return o.requireADLogin?e.requireADLogin!==!1:!!e.requireADLogin}var f=function(){var r=a.location.hash;if(e.isCallback(r)){var c=e.getRequestInfo(r);if(e.saveTokenFromHash(c),u.$$html5?a.location=a.location.origin+a.location.pathname:a.location.hash="",c.requestType!==e.REQUEST_TYPE.LOGIN&&(e.callback=a.parent.AuthenticationContext().callback,c.requestType===e.REQUEST_TYPE.RENEW_TOKEN&&(e.callback=a.parent.callBackMappedToRenewStates[c.stateResponse])),c.stateMatch)if("function"==typeof e.callback){if(c.requestType===e.REQUEST_TYPE.RENEW_TOKEN){if(c.parameters.access_token)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),c.parameters.access_token);if(c.parameters.id_token)return void e.callback(e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION),c.parameters.id_token)}}else t(e.config.loginResource),o.userName?(s(function(){t(e.config.loginResource),i.userInfo=o;var n=e._getItem(e.CONSTANTS.STORAGE.START_PAGE);n&&u.path(n)},1),i.$broadcast("adal:loginSuccess")):i.$broadcast("adal:loginFailure",e._getItem(e.CONSTANTS.STORAGE.ERROR_DESCRIPTION))}else t(e.config.loginResource),e._renewActive||o.isAuthenticated||!o.userName||e._getItem(e.CONSTANTS.STORAGE.FAILED_RENEW)||(n=!0,e.acquireToken(e.config.loginResource,function(r,t){r?(n=!1,i.$broadcast("adal:tokenRenewFailure","auto renew failure "+r,e.config.loginResource)):(n=!1,t&&(o.isAuthenticated=!0,i.$broadcast("adal:tokenRenewSuccess",e.config.loginResource)))}));s(function(){t(e.config.loginResource),i.userInfo=o},1)},g=function(){try{return window.self!==window.top}catch(e){return console&&console.error("isInIFrame: Unexpected error:",e),!0}},d=function(){e.info("Login event for:"+u.$$path),e.config&&e.config.localLoginUrl?u.path(e.config.localLoginUrl):(e._saveItem(e.CONSTANTS.STORAGE.START_PAGE,u.$$path),e.info("Start login at:"+window.location.href),i.$broadcast("adal:loginRedirect"),e.login())},h=function(r,t){t&&t.$$route&&l(t.$$route,e.config)&&(o.isAuthenticated||g()||n||(e.info("Route change event for:"+u.$$path),d()))},R=function(r,t){t&&l(t,e.config)&&(o.isAuthenticated||g()||n||(e.info("State change event for:"+u.$$path),d()))};return i.$on("$routeChangeStart",h),i.$on("$stateChangeStart",R),i.$on("$locationChangeStart",f),t(e.config.loginResource),i.userInfo=o,{config:e.config,login:function(){e.login()},loginInProgress:function(){return e.loginInProgress()},logOut:function(){e.logOut()},getCachedToken:function(o){return e.getCachedToken(o)},userInfo:o,acquireToken:function(o){var n=c.defer();return r[o]=e.getCachedToken(o),e.acquireToken(o,function(t,a){t?(e.error("Error when acquiring token for resource: "+o,t),i.$broadcast("adal:tokenRenewFailure","auto renew failure "+t,o),n.reject(t)):(n.resolve(a),r[o]!==a&&(i.$broadcast("adal:tokenRenewSuccess",o),r[o]=a))}),n.promise},getUser:function(){var o=c.defer();return e.getUser(function(n,r){n?(e.error("Error when getting user",n),o.reject(n)):o.resolve(r)}),o.promise},getResourceForEndpoint:function(o){return e.getResourceForEndpoint(o)},clearCache:function(){e.clearCache()},clearCacheForResource:function(o){e.clearCacheForResource(o)},info:function(o){e.info(o)},verbose:function(o){e.verbose(o)}}}]}),e.factory("ProtectedResourceInterceptor",["adalAuthenticationService","$q","$rootScope",function(e,o,n){return{request:function(n){if(n){n.headers=n.headers||{};var r=e.getResourceForEndpoint(n.url);if(null===r)return n;var t=e.getCachedToken(r),i=!1;if(t)return e.info("Token is avaliable for this url "+n.url),n.headers.Authorization="Bearer "+t,n;if(e.config)for(var a in e.config.endpoints)n.url.indexOf(a)>-1&&(i=!0);if(e.loginInProgress())return e.info("login already start."),o.reject();if(e.config&&i){var c=o.defer();return e.acquireToken(r).then(function(o){e.verbose("Token is avaliable"),n.headers.Authorization="Bearer "+o,c.resolve(n)},function(e){c.reject(e)}),c.promise}return n}},responseError:function(r){if(e.info("Getting error in the response"),r&&401===r.status){var t=e.getResourceForEndpoint(r.config.url);e.clearCacheForResource(t),n.$broadcast("adal:notAuthorized",r,t)}return o.reject(r)}}}])}else console.error("Angular.JS is not included")}();